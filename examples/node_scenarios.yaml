# Node Scenarios Configuration
# This configuration is based on verified metrics from UUID: 221c11c1-0d6f-4790-acdd-40118b954f1c
# Requires environment variables for dynamic configuration
# Example usage:
# export version=4.19
# export scenario_type=node_scenarios
# export cloud_infrastructure=AWS
# export cloud_type=self-managed
# export total_node_count=9
# export node_instance_type="*xlarge*"
# export network_plugins=OVNKubernetes
# export scenario_file="*time_scenario.yaml"
# orion cmd --config examples/node_scenarios.yaml --lookback 10d

tests:
  - name: krkn-hub-*
    version_field: cluster_version
    uuid_field: run_uuid
    metadata:
      cluster_version: "{{ version }}"
      scenarios.scenario_type: "{{ scenario_type }}"
      cloud_infrastructure: "{{ cloud_infrastructure }}"
      cloud_type: "{{ cloud_type }}"
      total_node_count: "{{ total_node_count }}"
      network_plugins: "{{ network_plugins }}"
      scenarios.scenario: "{{ scenario_file }}"
      scenarios.exit_status: 0
      scenarios.parameters.node_scenarios.label_selector: "{{ label_selector }}"
    metrics:
      # Recovery & Health metrics
      - name: affected_nodes_recovery
        threshold: 15
        direction: 1
        metricName.keyword: affected_nodes_recovery
        metric_of_interest: ready_time
        agg:
          value: ready_time
          agg_type: avg

      # ETCD Performance metrics
      - name: etcd_99th_backend_commit_duration
        threshold: 15
        direction: 1
        metricName.keyword: 99thEtcdDiskBackendCommit
        metric_of_interest: value
        agg:
          value: value
          agg_type: avg

      - name: etcd_99th_wal_fsync_duration
        threshold: 15
        direction: 1
        metricName.keyword: 99thEtcdDiskWalFsync
        metric_of_interest: value
        agg:
          value: value
          agg_type: avg

      - name: etcd_99th_round_trip_time
        threshold: 15
        direction: 1
        metricName.keyword: 99thEtcdRoundTripTime
        metric_of_interest: value
        agg:
          value: value
          agg_type: avg

      # API Server metrics
      - name: api_inflight_requests
        threshold: 15
        direction: 1
        metricName.keyword: APIInflightRequests
        metric_of_interest: value
        agg:
          value: value
          agg_type: max

      # CPU Usage metrics
      - name: cpu_cluster_usage_ratio
        threshold: 15
        direction: 1
        metricName.keyword: cpu-cluster-usage-ratio
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: avg

      - name: cpu_etcd
        threshold: 15
        direction: 1
        metricName.keyword: cpu-etcd
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: avg

      - name: cpu_kube_apiserver
        threshold: 15
        direction: 1
        metricName.keyword: cpu-kube-apiserver
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: avg

      - name: cpu_kubelet
        threshold: 15
        direction: 1
        metricName.keyword: cpu-kubelet
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: avg

      - name: cpu_masters
        threshold: 15
        direction: 1
        metricName.keyword: cpu-masters
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: avg

      - name: cpu_multus
        threshold: 15
        direction: 1
        metricName.keyword: cpu-multus
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: max

      - name: cpu_openshift_apiserver
        threshold: 15
        direction: 1
        metricName.keyword: cpu-openshift-apiserver
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: max

      - name: cpu_openshift_controller_manager
        threshold: 15
        direction: 1
        metricName.keyword: cpu-openshift-controller-manager
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: avg

      - name: cpu_ovn_control_plane
        threshold: 15
        direction: 1
        metricName.keyword: cpu-ovn-control-plane
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: avg

      - name: cpu_ovnkube_node
        threshold: 15
        direction: 1
        metricName.keyword: cpu-ovnkube-node
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: avg

      - name: cpu_workers
        threshold: 15
        direction: 1
        metricName.keyword: cpu-workers
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: avg

      # Max CPU metrics
      - name: max_cpu_crio
        threshold: 15
        direction: 1
        metricName.keyword: max-cpu-crio
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: max

      - name: max_cpu_infra
        threshold: 15
        direction: 1
        metricName.keyword: max-cpu-infra
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: max

      - name: max_cpu_kube_controller_manager
        threshold: 15
        direction: 1
        metricName.keyword: max-cpu-kube-controller-manager
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: max

      - name: max_cpu_kubelet
        threshold: 15
        direction: 1
        metricName.keyword: max-cpu-kubelet
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: max

      - name: max_cpu_workers
        threshold: 15
        direction: 1
        metricName.keyword: max-cpu-workers
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: max

      # Memory Usage metrics
      - name: memory_cluster_usage_ratio
        threshold: 15
        direction: 1
        metricName.keyword: memory-cluster-usage-ratio
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      - name: memory_crio
        threshold: 15
        direction: 1
        metricName.keyword: memory-crio
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      - name: memory_etcd
        threshold: 15
        direction: 1
        metricName.keyword: memory-etcd
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      - name: memory_infra
        threshold: 15
        direction: 1
        metricName.keyword: memory-infra
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      - name: memory_kube_apiserver
        threshold: 15
        direction: 1
        metricName.keyword: memory-kube-apiserver
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      - name: memory_kube_controller_manager
        threshold: 15
        direction: 1
        metricName.keyword: max-memory-kube-controller-manager
        metric_of_interest: value
        agg:
          value: mem
          agg_type: max

      - name: memory_kubelet
        threshold: 15
        direction: 1
        metricName.keyword: memory-kubelet
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      - name: memory_masters
        threshold: 15
        direction: 1
        metricName.keyword: memory-masters
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      - name: memory_multus
        threshold: 15
        direction: 1
        metricName.keyword: memory-multus
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      - name: memory_openshift_apiserver
        threshold: 15
        direction: 1
        metricName.keyword: memory-openshift-apiserver
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      - name: memory_openshift_controller_manager
        threshold: 15
        direction: 1
        metricName.keyword: memory-openshift-controller-manager
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      - name: memory_ovn_control_plane
        threshold: 15
        direction: 1
        metricName.keyword: memory-ovn-control-plane
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      - name: memory_ovnkube_node
        threshold: 15
        direction: 1
        metricName.keyword: memory-ovnkube-node
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      - name: memory_router
        threshold: 15
        direction: 1
        metricName.keyword: memory-router
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      - name: memory_sum_workers
        threshold: 15
        direction: 1
        metricName.keyword: memory-sum-workers
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      - name: memory_workers
        threshold: 15
        direction: 1
        metricName.keyword: memory-workers
        metric_of_interest: value
        agg:
          value: mem
          agg_type: avg

      # Max Memory metrics
      - name: max_memory_crio
        threshold: 15
        direction: 1
        metricName.keyword: max-memory-crio
        metric_of_interest: value
        agg:
          value: mem
          agg_type: max

      - name: max_memory_infra
        threshold: 15
        direction: 1
        metricName.keyword: max-memory-infra
        metric_of_interest: value
        agg:
          value: mem
          agg_type: max

      - name: max_memory_kube_controller_manager
        threshold: 15
        direction: 1
        metricName.keyword: max-memory-kube-controller-manager
        metric_of_interest: value
        agg:
          value: mem
          agg_type: max

      - name: max_memory_kubelet
        threshold: 15
        direction: 1
        metricName.keyword: max-memory-kubelet
        metric_of_interest: value
        agg:
          value: mem
          agg_type: max

      - name: max_memory_masters
        threshold: 15
        direction: 1
        metricName.keyword: max-memory-masters
        metric_of_interest: value
        agg:
          value: mem
          agg_type: max
          
      - name: max_cpu_prometheus
        threshold: 15
        direction: 1
        metricName.keyword: max-cpu-prometheus
        metric_of_interest: value
        agg:
          value: cpu
          agg_type: avg

      - name: max_memory_prometheus
        threshold: 15
        direction: 1
        metricName.keyword: max-memory-prometheus
        metric_of_interest: value
        agg:
          value: mem
          agg_type: max

      - name: max_memory_sum_infra
        threshold: 15
        direction: 1
        metricName.keyword: max-memory-sum-infra
        metric_of_interest: value
        agg:
          value: mem
          agg_type: max

      - name: max_memory_sum_kubelet
        threshold: 15
        direction: 1
        metricName.keyword: max-memory-sum-kubelet
        metric_of_interest: value
        agg:
          value: mem
          agg_type: max

      - name: max_memory_workers
        threshold: 15
        direction: 1
        metricName.keyword: max-memory-workers
        metric_of_interest: value
        agg:
          value: mem
          agg_type: max

      # Node CPU Seconds metrics
      - name: node_cpu_seconds_infra
        threshold: 15
        direction: 1
        metricName.keyword: nodeCPUSeconds-Infra
        metric_of_interest: value
        agg:
          value: value
          agg_type: avg

      - name: node_cpu_seconds_masters
        threshold: 15
        direction: 1
        metricName.keyword: nodeCPUSeconds-Masters
        metric_of_interest: value
        agg:
          value: value
          agg_type: avg

      - name: node_cpu_seconds_workers
        threshold: 15
        direction: 1
        metricName.keyword: nodeCPUSeconds-Workers
        metric_of_interest: value
        agg:
          value: value
          agg_type: avg
